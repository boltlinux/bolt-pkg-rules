<?xml version="1.0" encoding="utf-8"?>
<rules>
    <prepare>
    <![CDATA[

cd "$BOLT_SOURCE_DIR"
bh_autotools_dev_update
autoreconf -vfi

    ]]>
    </prepare>

    <build>
    <![CDATA[

# make sure we use the right ICU
mkdir -p "$BOLT_BUILD_DIR/bindir"
ln -sf "$BOLT_INSTALL_PREFIX/bin/icu-config" "$BOLT_BUILD_DIR/bindir"
export PATH="$BOLT_BUILD_DIR/bindir:$PATH"

export PYTHON="$BOLT_INSTALL_PREFIX/bin/python2"
cp -a "$BOLT_SOURCE_DIR" "$BOLT_BUILD_DIR/python2"
cd "$BOLT_BUILD_DIR/python2"

./configure \
    --prefix="$BOLT_INSTALL_PREFIX" \
    --build="$BOLT_HOST_TYPE" \
    --host="$BOLT_HOST_TYPE" \
    --disable-silent-rules \
    --with-history \
    --with-icu \
    --with-python="$BOLT_INSTALL_PREFIX/bin/python2"

make PYTHON_INCLUDES="-I=$BOLT_INSTALL_PREFIX/include/python2.7" \
    -j"$BOLT_PARALLEL_JOBS"

export PYTHON="$BOLT_INSTALL_PREFIX/bin/python3"
cp -a "$BOLT_SOURCE_DIR" "$BOLT_BUILD_DIR/python3"
cd "$BOLT_BUILD_DIR/python3"

./configure \
    --prefix="$BOLT_INSTALL_PREFIX" \
    --build="$BOLT_HOST_TYPE" \
    --host="$BOLT_HOST_TYPE" \
    --disable-silent-rules \
    --with-history \
    --with-icu \
    --with-python="$BOLT_INSTALL_PREFIX/bin/python3"

make PYTHON_INCLUDES="-I=$BOLT_INSTALL_PREFIX/include/python3.5m" \
    -j"$BOLT_PARALLEL_JOBS"

    ]]>
    </build>

    <install>
    <![CDATA[

cd "$BOLT_BUILD_DIR/python2"
make DESTDIR="$BOLT_INSTALL_DIR" install
cd "$BOLT_INSTALL_DIR/$BOLT_INSTALL_PREFIX/lib/python2"*
find . -name "*.py" -exec \
    python2 -c "import py_compile; py_compile.compile('{}')" \;

cd "$BOLT_BUILD_DIR/python3"
make DESTDIR="$BOLT_INSTALL_DIR" install
cd "$BOLT_INSTALL_DIR/$BOLT_INSTALL_PREFIX/lib/python3"*
find . -name "*.py" -exec \
    python3 -c "import py_compile; py_compile.compile('{}')" \;

    ]]>
    </install>
</rules>
